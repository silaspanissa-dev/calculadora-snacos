<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SN Aços — Calculadora de Preço</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; margin: 0; background:#f6f7f9; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border-radius: 16px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.06); margin-bottom: 12px;}
    h1 { font-size: 18px; margin: 0 0 8px; }
    h2 { font-size: 14px; margin: 0 0 10px; color:#444; }
    label { display:block; font-size: 12px; color:#444; margin: 10px 0 6px; }
    input { width: 100%; padding: 12px; border: 1px solid #d7dbe0; border-radius: 12px; font-size: 16px; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    button { width:100%; padding: 12px; border:0; border-radius: 12px; font-size: 16px; font-weight:700; }
    .btn { background:#111; color:#fff; }
    .btn2 { background:#1f7a3a; color:#fff; } /* estilo “WhatsApp” sem citar cor exata */
    .muted { color:#666; font-size: 12px; line-height: 1.4; }
    .res { font-size: 22px; font-weight: 800; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .pill { background:#f1f3f6; padding: 10px; border-radius: 12px; }
    .small { font-size: 12px; color:#444; }
    .checkrow { display:flex; gap:10px; align-items:center; margin-top:10px; }
    .checkrow input { width:auto; }
    .btnrow { display:flex; gap:10px; margin-top:12px; }
    .btnrow button { flex: 1; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Calculadora de Preço (SN Aços)</h1>
    <div class="muted">
      Regras: ICMS benefício 3% (sobre a base final da venda), parcela R$ 6,90.
      Comissões sobre valor s/IPI. Perdas aumentam custo por ton vendida.
      <br><br>
      <b>Margem exibida</b> = margem real (igual planilha): <b>Lucro ÷ Preço de venda (base final)</b>.
    </div>
  </div>

  <div class="card">
    <h2>Entradas</h2>

    <label>Custo do material s/IPI (R$/ton)</label>
    <input id="custo" type="number" step="0.01" value="5000">

    <div class="row">
      <div>
        <label>Volume (ton)</label>
        <input id="vol" type="number" step="0.001" value="5">
      </div>
      <div>
        <label>Margem alvo (%)</label>
        <input id="margem" type="number" step="0.01" value="15.00">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Perdas (%)</label>
        <input id="perdas" type="number" step="0.01" value="0">
      </div>
      <div>
        <label>Frete de venda (R$/ton)</label>
        <input id="freteVenda" type="number" step="0.01" value="250">
      </div>
    </div>

    <label>Beneficiamento (R$/ton)</label>
    <input id="benef" type="number" step="0.01" value="110">

    <div class="row">
      <div>
        <label>Parcelas (nº)</label>
        <input id="parcelas" type="number" step="1" value="3">
      </div>
      <div>
        <label>Custo por parcela (R$)</label>
        <input id="custoParcela" type="number" step="0.01" value="6.90">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Comissão comprador (%)</label>
        <input id="comCompr" type="number" step="0.01" value="0">
      </div>
      <div>
        <label>Comissão venda (%)</label>
        <input id="comVend" type="number" step="0.01" value="1.50">
      </div>
    </div>

    <div class="row">
      <div>
        <label>IPI COMPRA (%)</label>
        <input id="ipiCompra" type="number" step="0.01" value="3.25">
      </div>
      <div>
        <label>IPI VENDA (%)</label>
        <input id="ipiVenda" type="number" step="0.01" value="3.25">
      </div>
    </div>

    <div class="checkrow">
      <input id="semNf" type="checkbox" />
      <label for="semNf" style="margin:0;">Venda sem NF (não tem IPI na venda)</label>
    </div>

    <div class="row">
      <div>
        <label>ICMS benefício (%)</label>
        <input id="icmsBen" type="number" step="0.01" value="3.00">
      </div>
      <div>
        <label>&nbsp;</label>
        <div class="muted">ICMS incide sobre a base final de venda (com IPI se houver).</div>
      </div>
    </div>

    <div class="btnrow">
      <button class="btn" id="calc">Calcular preço</button>
      <button class="btn2" id="copy">Copiar resumo</button>
    </div>

    <div class="muted" id="copyMsg" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <h2>Resultados</h2>
    <div class="grid2">
      <div class="pill">
        <div class="small">Preço de venda s/IPI (R$/ton)</div>
        <div class="res" id="pvSem">—</div>
      </div>

      <div class="pill">
        <div class="small">Preço de venda (base final) (R$/ton)</div>
        <div class="res" id="pvBase">—</div>
      </div>

      <div class="pill">
        <div class="small">Lucro (R$/ton)</div>
        <div class="res" id="lucroTon">—</div>
      </div>

      <div class="pill">
        <div class="small">Lucro total (R$)</div>
        <div class="res" id="lucroTotal">—</div>
      </div>

      <div class="pill">
        <div class="small">Margem real (%)</div>
        <div class="res" id="mReal">—</div>
      </div>

      <div class="pill">
        <div class="small">Receita total (base final) (R$)</div>
        <div class="res" id="receitaTotal">—</div>
      </div>
    </div>

    <div class="muted" id="debug" style="margin-top:10px"></div>
  </div>
</div>

<script>
  const fmtBRL = (n) => n.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
  const fmtPct = (n) => n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%";
  const fmtNum = (n, d=3) => n.toLocaleString('pt-BR', { minimumFractionDigits: d, maximumFractionDigits: d });

  function val(id){ return parseFloat(document.getElementById(id).value || "0"); }
  function byId(id){ return document.getElementById(id); }

  function calcular(){
    const C = val('custo');                 // R$/ton s/IPI
    const V = Math.max(val('vol'), 0.000001);
    const mAlvo = val('margem')/100;        // margem alvo (para sugerir o PV)
    const perdas = val('perdas')/100;
    const freteVenda = val('freteVenda');
    const benef = val('benef');
    const parcelas = Math.max(Math.round(val('parcelas')), 0);
    const custoParcela = val('custoParcela');
    const comCompr = val('comCompr')/100;
    const comVend  = val('comVend')/100;
    const ipiCompra = val('ipiCompra')/100;

    const semNf = byId('semNf').checked;
    const ipiVenda = semNf ? 0 : (val('ipiVenda')/100);

    const icmsBen = val('icmsBen')/100;

    const adj = 1 / (1 - perdas); // ajuste por perdas

    const boletoPorTon = (custoParcela * parcelas) / (V * (1 - perdas));

    // Custos fixos s/IPI por ton vendida (igual planilha)
    const baseSemIPI = (C + freteVenda + benef) * adj;

    // IPI compra entra no custo, sempre (ajustado por perdas)
    const ipiCompraR = (C * ipiCompra) * adj;

    const comissoes = comCompr + comVend;

    // Sugerir PV (s/IPI) pela margem alvo, mas exibir margem real depois
    const denom = (1 + ipiVenda) * (1 - mAlvo - icmsBen) - comissoes;

    const debugEl = byId('debug');
    if (denom <= 0){
      debugEl.innerText =
        "Atenção: a combinação de margem alvo + ICMS + comissões deixou o cálculo impossível (denominador <= 0). Reduza a margem alvo ou revise parâmetros.";
      return null;
    } else {
      debugEl.innerText = semNf
        ? "Modo: Venda sem NF → IPI na venda = 0% (custo mantém IPI compra)."
        : "";
    }

    const PV = (baseSemIPI + ipiCompraR + boletoPorTon) / denom; // venda s/IPI
    const baseFinal = PV * (1 + ipiVenda);                       // venda base final (com IPI se houver)

    // Lucro REAL e margem REAL (igual planilha)
    const custoTotal = baseSemIPI + ipiCompraR + boletoPorTon + (PV * comissoes) + (baseFinal * icmsBen);
    const lucroTon = baseFinal - custoTotal;
    const margemReal = lucroTon / baseFinal;

    const lucroTotal = lucroTon * V;
    const receitaTotal = baseFinal * V;

    byId('pvSem').innerText = fmtBRL(PV);
    byId('pvBase').innerText = fmtBRL(baseFinal);
    byId('lucroTon').innerText = fmtBRL(lucroTon);
    byId('lucroTotal').innerText = fmtBRL(lucroTotal);
    byId('mReal').innerText = fmtPct(margemReal * 100);
    byId('receitaTotal').innerText = fmtBRL(receitaTotal);

    return {
      C, V, mAlvo, perdas, freteVenda, benef, parcelas, custoParcela,
      comCompr, comVend, ipiCompra, ipiVenda, icmsBen,
      PV, baseFinal, lucroTon, lucroTotal, margemReal, receitaTotal, semNf
    };
  }

  async function copiarResumo(){
    const msgEl = byId('copyMsg');
    msgEl.innerText = "";
    const r = calcular();
    if (!r) return;

    const perdasPct = r.perdas * 100;
    const comComprPct = r.comCompr * 100;
    const comVendPct = r.comVend * 100;
    const ipiCompraPct = r.ipiCompra * 100;
    const ipiVendaPct = r.ipiVenda * 100;
    const icmsPct = r.icmsBen * 100;
    const margemAlvoPct = r.mAlvo * 100;
    const margemRealPct = r.margemReal * 100;

    const texto =
`SN Aços • Cálculo de Preço
${r.semNf ? "Modo: VENDA SEM NF (IPI na venda = 0%)" : "Modo: Venda com NF"}

Entradas:
• Volume: ${fmtNum(r.V, 3)} ton
• Custo material s/IPI: ${fmtBRL(r.C)}/ton
• Frete venda: ${fmtBRL(r.freteVenda)}/ton
• Beneficiamento: ${fmtBRL(r.benef)}/ton
• Perdas: ${perdasPct.toFixed(2).replace('.', ',')}%
• Parcelas: ${r.parcelas} (R$ ${r.custoParcela.toFixed(2).replace('.', ',')} cada)
• Comissão comprador: ${comComprPct.toFixed(2).replace('.', ',')}%
• Comissão venda: ${comVendPct.toFixed(2).replace('.', ',')}%
• IPI compra: ${ipiCompraPct.toFixed(2).replace('.', ',')}%
• IPI venda: ${ipiVendaPct.toFixed(2).replace('.', ',')}%
• ICMS benefício: ${icmsPct.toFixed(2).replace('.', ',')}%
• Margem alvo: ${margemAlvoPct.toFixed(2).replace('.', ',')}%

Resultados:
• PV s/IPI: ${fmtBRL(r.PV)}/ton
• PV (base final): ${fmtBRL(r.baseFinal)}/ton
• Margem real: ${margemRealPct.toFixed(2).replace('.', ',')}%
• Lucro: ${fmtBRL(r.lucroTon)}/ton
• Lucro total: ${fmtBRL(r.lucroTotal)}
• Receita total (base final): ${fmtBRL(r.receitaTotal)}
`;

    try{
      await navigator.clipboard.writeText(texto);
      msgEl.innerText = "✅ Resumo copiado. Agora é só colar no WhatsApp.";
    } catch(e){
      // fallback simples (alguns navegadores travam clipboard)
      const ta = document.createElement("textarea");
      ta.value = texto;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, 999999);
      try{
        document.execCommand("copy");
        msgEl.innerText = "✅ Resumo copiado. Agora é só colar no WhatsApp.";
      } catch(err){
        msgEl.innerText = "Não consegui copiar automaticamente. Se quiser, eu adapto para abrir um pop-up com o texto para você copiar manualmente.";
      }
      document.body.removeChild(ta);
    }
  }

  byId('calc').addEventListener('click', calcular);
  byId('copy').addEventListener('click', copiarResumo);
  byId('semNf').addEventListener('change', calcular);

  calcular();
</script>
</body>
</html>
