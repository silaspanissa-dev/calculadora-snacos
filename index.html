<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SN Aços — Calculadora de Preço</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; margin: 0; background:#f6f7f9; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border-radius: 16px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.06); margin-bottom: 12px;}
    h1 { font-size: 18px; margin: 0 0 8px; }
    h2 { font-size: 14px; margin: 0 0 10px; color:#444; }
    label { display:block; font-size: 12px; color:#444; margin: 10px 0 6px; }
    input { width: 100%; padding: 12px; border: 1px solid #d7dbe0; border-radius: 12px; font-size: 16px; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    button { width:100%; padding: 12px; border:0; border-radius: 12px; font-size: 16px; font-weight:600; }
    .btn { background:#111; color:#fff; }
    .muted { color:#666; font-size: 12px; line-height: 1.4; }
    .res { font-size: 22px; font-weight: 800; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .pill { background:#f1f3f6; padding: 10px; border-radius: 12px; }
    .small { font-size: 12px; color:#444; }
    .right { text-align:right; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Calculadora de Preço (SN Aços)</h1>
    <div class="muted">
      Fixos: ICMS benefício 3% (sobre NF com IPI), IPI padrão 3,25%, custo parcela R$ 6,90.
      Comissões incidem sobre valor s/IPI. Perdas aumentam custo por ton vendida.
    </div>
  </div>

  <div class="card">
    <h2>Entradas</h2>

    <label>Custo do material s/IPI (R$/ton)</label>
    <input id="custo" type="number" step="0.01" value="5686">

    <div class="row">
      <div>
        <label>Volume (ton)</label>
        <input id="vol" type="number" step="0.001" value="10">
      </div>
      <div>
        <label>Margem líquida desejada (%)</label>
        <input id="margem" type="number" step="0.01" value="10.86">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Frete (R$/ton)</label>
        <input id="frete" type="number" step="0.01" value="250">
      </div>
      <div>
        <label>Perdas (%)</label>
        <input id="perdas" type="number" step="0.01" value="0">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Parcelas (nº)</label>
        <input id="parcelas" type="number" step="1" value="3">
      </div>
      <div>
        <label>Custo por parcela (R$)</label>
        <input id="custoParcela" type="number" step="0.01" value="6.90">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Comissão comprador (%)</label>
        <input id="comCompr" type="number" step="0.01" value="0">
      </div>
      <div>
        <label>Comissão venda (%)</label>
        <input id="comVend" type="number" step="0.01" value="1.50">
      </div>
    </div>

    <div class="row">
      <div>
        <label>IPI (%)</label>
        <input id="ipi" type="number" step="0.01" value="3.25">
      </div>
      <div>
        <label>ICMS benefício (%) (fixo)</label>
        <input id="icmsBen" type="number" step="0.01" value="3.00">
      </div>
    </div>

    <div style="margin-top:12px">
      <button class="btn" id="calc">Calcular preço</button>
    </div>
  </div>

  <div class="card">
    <h2>Resultados</h2>
    <div class="grid2">
      <div class="pill">
        <div class="small">Preço de venda s/IPI (R$/ton)</div>
        <div class="res" id="pvSem">—</div>
      </div>
      <div class="pill">
        <div class="small">Preço de venda c/IPI (R$/ton)</div>
        <div class="res" id="pvCom">—</div>
      </div>
      <div class="pill">
        <div class="small">Lucro (R$/ton)</div>
        <div class="res" id="lucro">—</div>
      </div>
      <div class="pill">
        <div class="small">Margem conferida (%)</div>
        <div class="res" id="mConf">—</div>
      </div>
    </div>
    <div class="muted" id="debug" style="margin-top:10px"></div>
  </div>
</div>

<script>
  const fmtBRL = (n) => n.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
  const fmtNum = (n) => n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  function val(id){ return parseFloat(document.getElementById(id).value || "0"); }

  function calcular(){
    const C = val('custo');           // R$/ton s/IPI
    const V = Math.max(val('vol'), 0.000001); // ton
    const m = val('margem')/100;      // margem líquida desejada (sobre PV com IPI)
    const perdas = val('perdas')/100; // % perdas
    const frete = val('frete');       // R$/ton
    const parcelas = Math.max(Math.round(val('parcelas')), 0);
    const custoParcela = val('custoParcela'); // R$
    const comCompr = val('comCompr')/100;     // % s/IPI
    const comVend  = val('comVend')/100;      // % s/IPI
    const i = val('ipi')/100;         // IPI
    const icmsBen = val('icmsBen')/100; // ICMS benefício 3% sobre PV com IPI

    // Ajuste por perdas: custo por ton vendida aumenta
    const adj = 1 / (1 - perdas);

    // Custos fixos por ton vendida (já ajustado por perdas)
    const boletoPorTon = (custoParcela * parcelas) / (V * (1 - perdas));
    const baseSemIPI = (C + frete) * adj;
    const ipiCompra = (C * i) * adj;

    // Denominador (isola PV) mantendo sua lógica:
    // lucro = PV*(1+i) - [ baseSemIPI + ipiCompra + PV*(comissões) + PV*(1+i)*icmsBen + boletoPorTon ]
    // margem líquida m = lucro / (PV*(1+i))
    // => PV = (baseSemIPI + ipiCompra + boletoPorTon) / ( (1+i)*(1-m-icmsBen) - (comissões) )
    const comissoes = comCompr + comVend;
    const denom = (1+i) * (1 - m - icmsBen) - comissoes;

    if (denom <= 0){
      document.getElementById('debug').innerText =
        "Atenção: combinações de margem + impostos + comissões deixaram o cálculo impossível (denominador <= 0). Reduza a margem ou verifique parâmetros.";
      return;
    } else {
      document.getElementById('debug').innerText = "";
    }

    const PV = (baseSemIPI + ipiCompra + boletoPorTon) / denom; // preço s/IPI
    const PVc = PV * (1+i);

    // Recalcula lucro com a própria equação (conferência)
    const custoTotal = baseSemIPI + ipiCompra + boletoPorTon + (PV * comissoes) + (PVc * icmsBen);
    const lucro = PVc - custoTotal;
    const mConf = lucro / PVc;

    document.getElementById('pvSem').innerText = fmtBRL(PV);
    document.getElementById('pvCom').innerText = fmtBRL(PVc);
    document.getElementById('lucro').innerText = fmtBRL(lucro);
    document.getElementById('mConf').innerText = fmtNum(mConf*100) + "%";
  }

  document.getElementById('calc').addEventListener('click', calcular);
  calcular();
</script>
</body>
</html>
